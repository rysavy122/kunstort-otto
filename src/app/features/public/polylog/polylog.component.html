<!-- polylog.component.html -->
<div id="wrapper">
  <div id="button-div">
    <button (click)="openDialog()" class="comment-button">Kommentieren</button>
  </div>
  <h1 id="forschungsfrage">{{ forschungsfrage }}</h1>

  <!-- Iterate over comments and use the template for each -->
  <ng-container *ngFor="let kommentar of kommentare; trackBy: trackById">
    <ng-container
      *ngTemplateOutlet="commentTemplate; context: { $implicit: kommentar }"
    ></ng-container>
  </ng-container>

  <app-comment-dialog
    #commentDialog
    [isOpen]="isDialogOpen"
    (close)="closeDialog()"
    (commentSubmitted)="onCommentSubmitted($event)"
  >
  </app-comment-dialog>

  <!-- Template for rendering a comment -->
  <ng-template #commentTemplate let-comment let-isReply="isReply">
    <div
      #draggableElement
      class="commentar"
      [ngStyle]="comment.style"
      [class.commentar]="!isReply"
      [class.replies]="isReply"
    >
      <h4>{{ comment.title }}</h4>
      <p [innerHTML]="getSafeHtml(comment.comment)"></p>
      <p>Datum: {{ comment.createdAt | date }}</p>
      <br />
      <div class="icons">
        <svg
          (click)="toggleMenu(comment.id!)"
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-three-dots"
          viewBox="0 0 16 16"
        >
          <path
            d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"
          />
        </svg>
        <div
          *ngIf="isMenuOpen && activeCommentId === comment.id"
          class="menu"
          [class.menu]="!isReply"
          [class.reply-menu]="isReply"
          [class.show]="isMenuOpen"
        >
          <button (click)="editKommentar(comment.id)">Edit</button>
          <button (click)="openReplyDialog(comment.id)">Reply</button>
          <button (click)="deleteKommentar(comment.id)">Delete</button>
        </div>
      </div>

      <!-- Check and render replies recursively -->
    </div>
    <div *ngIf="comment.replies && comment.replies.length">
      <ng-container
        class="replies"
        *ngFor="let reply of comment.replies; trackBy: trackById"
      >
        <ng-container
          *ngTemplateOutlet="commentTemplate; context: { $implicit: reply, isReply: true }"
        ></ng-container>
      </ng-container>
    </div>
  </ng-template>
</div>
